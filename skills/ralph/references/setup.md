# Ralph Setup Workflow

Configure Ralph for your agent harness and task source.

## Quick Setup

```
User: set up ralph

Assistant: Choose your task source:
1. PRD Markdown file - Generated by /prd command (recommended)
2. PRD JSON file - Tasks defined in a JSON file
3. task_list - Tasks stored in amp's task system

[User selects option 1]

Assistant: Path to your PRD markdown file? (e.g., tasks/prd-feature.md)

[User provides path]

Assistant: What agent harness are you using?
1. Generic (/new command) - opencode, claude, etc.
2. amp - Built-in handoff

[User selects option 1]

Assistant: [Creates ralph.json]
âœ… Ralph configured! Run "ralph" to start execution.
```

## Manual Setup

### Step 1: Create ralph.json

```json
{
  "version": "1.0",
  "taskSource": {
    "type": "prd-json",
    "path": "tasks/prd.json"
  },
  "prompt": "Implement the next ready task from the PRD. Ensure typecheck passes, tests pass, and changes are committed.",
  "harness": {
    "type": "generic",
    "newSessionCommand": "/new"
  },
  "qualityChecks": {
    "typecheck": "npm run typecheck",
    "test": "npm run test",
    "lint": null
  },
  "progressFile": "scripts/ralph/progress.json"
}
```

### Step 2: Create Task Source

**Option A: PRD Markdown File (Recommended)**

Generate a PRD using the `prd` skill, or create manually at `/tasks/prd-[feature-name].md`:

```markdown
# PRD: Feature Name

## User Stories

### US-001: First story
**Description:** As a user, I want...

**Acceptance Criteria:**
- [ ] Criterion 1
- [ ] Criterion 2
- [ ] Typecheck passes

### US-002: Second story
**Description:** ...

**Acceptance Criteria:**
- [ ] ...
```

Ralph will:
- Parse user stories (US-001, US-002, etc.)
- Create sequential dependencies (US-002 depends on US-001)
- Track progress via acceptance criteria checkboxes

**Option B: PRD JSON File**

Create a JSON file with your tasks:

```json
{
  "feature": "User Authentication",
  "description": "Add user login and registration",
  "tasks": [
    {
      "id": "auth-1",
      "title": "Create users table migration",
      "description": "Add users table with id, email, password_hash, created_at columns",
      "dependencies": [],
      "status": "open",
      "acceptanceCriteria": [
        "Migration runs successfully",
        "Typecheck passes"
      ]
    },
    {
      "id": "auth-2",
      "title": "Implement password hashing",
      "description": "Create utility function to hash passwords using bcrypt",
      "dependencies": ["auth-1"],
      "status": "open",
      "acceptanceCriteria": [
        "Function hashes passwords with bcrypt",
        "Tests pass",
        "Typecheck passes"
      ]
    },
    {
      "id": "auth-3",
      "title": "Create login API endpoint",
      "description": "POST /api/login validates credentials and returns JWT token",
      "dependencies": ["auth-2"],
      "status": "open",
      "acceptanceCriteria": [
        "Endpoint validates email/password",
        "Returns JWT on success",
        "Returns 401 on invalid credentials",
        "Tests pass",
        "Typecheck passes"
      ]
    }
  ]
}
```

**Option C: task_list (amp)**

Use existing amp tasks with parent/subtask relationships. Set `parentTaskId` in ralph.json.

### Step 3: Create Progress Directory

```bash
mkdir -p scripts/ralph/archive
```

### Step 4: Verify Setup

```bash
# Check ralph.json exists
cat ralph.json

# Check task source exists (for PRD markdown)
cat tasks/prd-*.md

# OR check task source exists (for PRD JSON)
cat tasks/prd.json

# Check progress directory
ls -la scripts/ralph/
```

## Configuration Options

### Task Source Types

**prd-markdown** (PRD skill output - recommended):
```json
{
  "taskSource": {
    "type": "prd-markdown",
    "path": "tasks/prd-feature-name.md"
  }
}
```
Ralph parses user stories (US-001, US-002, etc.) and converts them to tasks with sequential dependencies.

**prd-json:**
```json
{
  "taskSource": {
    "type": "prd-json",
    "path": "path/to/prd.json"
  }
}
```

**task-list:**
```json
{
  "taskSource": {
    "type": "task-list",
    "parentTaskId": "task-abc123"
  }
}
```

### Harness Types

**generic** (opencode, claude, etc.):
```json
{
  "harness": {
    "type": "generic",
    "newSessionCommand": "/new"
  }
}
```

**amp**:
```json
{
  "harness": {
    "type": "amp"
  }
}
```

### Quality Checks

Configure which checks to run after each task:

```json
{
  "qualityChecks": {
    "typecheck": "npm run typecheck",
    "test": "npm run test",
    "lint": "npm run lint",
    "custom": "./scripts/verify.sh"
  }
}
```

Set any to `null` to skip that check.

## Example Configurations

### PRD Markdown with Generic Harness (Recommended)

```json
{
  "version": "1.0",
  "taskSource": {
    "type": "prd-markdown",
    "path": "tasks/prd-user-profile.md"
  },
  "prompt": "Implement the next user story from the PRD. Find the first US-XXX with unchecked acceptance criteria, implement it, check off all criteria, run quality checks, and commit.",
  "harness": {
    "type": "generic",
    "newSessionCommand": "/new"
  },
  "qualityChecks": {
    "typecheck": "npm run typecheck",
    "test": "npm run test",
    "lint": "npm run lint"
  },
  "progressFile": "scripts/ralph/progress.json"
}
```

### Node.js/TypeScript Project with PRD JSON

```json
{
  "version": "1.0",
  "taskSource": {
    "type": "prd-json",
    "path": "tasks/feature.json"
  },
  "prompt": "Implement the next task. Run typecheck and tests. Commit when passing.",
  "harness": {
    "type": "generic",
    "newSessionCommand": "/new"
  },
  "qualityChecks": {
    "typecheck": "npm run typecheck",
    "test": "npm run test",
    "lint": "npm run lint"
  },
  "progressFile": "scripts/ralph/progress.json"
}
```

### Python Project

```json
{
  "version": "1.0",
  "taskSource": {
    "type": "prd-json",
    "path": "tasks/feature.json"
  },
  "prompt": "Implement the next task. Run tests and typecheck. Commit when passing.",
  "harness": {
    "type": "generic",
    "newSessionCommand": "/new"
  },
  "qualityChecks": {
    "typecheck": "mypy src/",
    "test": "pytest",
    "lint": "ruff check ."
  },
  "progressFile": "scripts/ralph/progress.json"
}
```

### Amp with task_list

```json
{
  "version": "1.0",
  "taskSource": {
    "type": "task-list",
    "parentTaskId": "task-abc123"
  },
  "prompt": "Implement the next ready task. All quality checks must pass.",
  "harness": {
    "type": "amp"
  },
  "qualityChecks": {
    "typecheck": "npm run typecheck",
    "test": "npm run test"
  },
  "progressFile": "scripts/ralph/progress.json"
}
```

## PRD JSON Schema

```typescript
interface PRD {
  feature: string;
  description?: string;
  tasks: Task[];
}

interface Task {
  id: string;
  title: string;
  description: string;
  dependencies: string[];
  status: "open" | "in-progress" | "completed" | "blocked";
  acceptanceCriteria?: string[];
}
```

## Checklist

Before running ralph:

- [ ] ralph.json exists and is valid JSON
- [ ] Task source exists (prd.json or parent task exists)
- [ ] Quality check commands are correct for your project
- [ ] scripts/ralph/ directory exists
- [ ] Git repo initialized (for commits)
- [ ] At least one task has no dependencies (can start immediately)

## Troubleshooting

**"Task source not found"**
- Verify the path in ralph.json matches your file location
- Check that prd.json is valid JSON

**"No ready tasks found"**
- Check that at least one task has empty `dependencies` array
- Verify no circular dependencies exist

**"Quality checks fail"**
- Run the commands manually to see errors
- Fix issues before running ralph again

**"Cannot create new session"**
- Verify your harness type matches your agent
- For generic harness, ensure `/new` command works in your agent
